<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Individu - Skrining Kesehatan</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      body {
        background: linear-gradient(135deg, #e0f2fe, #fef9c3);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        min-height: 100vh; /* full screen */
        display: flex;
        flex-direction: column;
      }

      .header {
        text-align: center;
        padding: 15px;
        color: #3b5208;
        font-weight: bold;
      }

      .card-profile,
      .pemeriksaan {
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 15px;
        margin-bottom: 15px;
      }

      footer {
        text-align: center;
        padding: 10px 0;
        font-size: 0.9rem;
        color: #333;
        background: transparent;
        margin-top: auto; /* dorong ke bawah */
      }

      #pemeriksaanTable td {
        vertical-align: top;
        padding: 0.5rem 0.75rem;
      }

      #pemeriksaanTable tr:hover {
        background-color: #f9f9f9;
      }

      /* Progress bulat */
      .progress-container {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto;
        border-radius: 50%;
        background: #eee;
        overflow: hidden;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
      }

      .wave-svg {
        width: 80px;
        height: 80px;
        overflow: visible;
      }

      .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        font-size: 1.2rem;
        color: #333;
      }

      @keyframes waveMove {
        0% {
          transform: translateX(-25%);
        }
        100% {
          transform: translateX(25%);
        }
      }

      /* Scroll dinamis untuk bagian tabel pemeriksaan */
      #pemeriksaanMandiriWrapper {
        flex: 1;
        min-height: 0; /* biar fleksibel */
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        background: #fff;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <!-- <div class="container mt-2">
    <a href="skrining-x.html" class="btn btn-secondary mb-2 shadow">‚¨Ö Kembali</a>
  </div> -->
    <div class="header">
      <h3>ü©∫ Cek Kesehatan Anak Sekolah</h3>
    </div>

    <div class="container">
      <!-- Profil Siswa -->
      <div class="card p-3 shadow-sm mb-3">
        <div class="row align-items-center g-3">
          <!-- Biodata -->
          <div class="col-md-8">
            <h6 class="fw-bold text-primary mb-2">üìã Biodata</h6>
            <ul class="list-group list-group-flush small">
              <li class="list-group-item py-1 d-flex justify-content-between">
                <span class="fw-semibold">Nama</span>
                <span id="nama" class="text-muted">-</span>
              </li>
              <li class="list-group-item py-1 d-flex justify-content-between">
                <span class="fw-semibold">NIK</span>
                <span id="nik" class="text-muted">-</span>
              </li>
              <li class="list-group-item py-1 d-flex justify-content-between">
                <span class="fw-semibold">Tanggal Lahir</span>
                <span id="tgl" class="text-muted">-</span>
              </li>
              <li class="list-group-item py-1 d-flex justify-content-between">
                <span class="fw-semibold">Umur</span>
                <span id="umur" class="text-muted">-</span>
              </li>
              <li class="list-group-item py-1 d-flex justify-content-between">
                <span class="fw-semibold">Jenis Kelamin</span>
                <span id="jk" class="text-muted">-</span>
              </li>
              <li class="list-group-item py-1 d-flex justify-content-between">
                <span class="fw-semibold">Nama Ibu/Wali</span>
                <span id="ibu" class="text-muted">-</span>
              </li>
              <li class="list-group-item py-1 d-flex justify-content-between">
                <span class="fw-semibold">Nomor Telepon</span>
                <span id="tiket" class="text-muted">-</span>
              </li>
            </ul>
          </div>

          <!-- Foto & Progress -->
          <div class="col-md-4">
            <div class="d-flex justify-content-center align-items-center gap-3">
              <!-- Foto -->
              <div class="text-center">
                <img
                  src="../../assets/man.png"
                  alt="Foto Siswa"
                  class="img-fluid rounded"
                  style="max-width: 80px"
                />
                <div class="mt-1 small text-muted"></div>
              </div>

              <!-- Progress -->
              <div class="text-center">
                <div
                  class="progress-container mb-1"
                  style="width: 80px; margin: 0 auto"
                >
                  <svg
                    viewBox="0 0 120 120"
                    class="wave-svg"
                    style="width: 80px; height: 80px"
                  >
                    <path id="wavePath" fill="#4facfe"></path>
                  </svg>
                  <div class="progress-text small" id="statusText">0%</div>
                </div>
                <span class="text-primary fw-semibold small d-block"
                  >Keterselesaian</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pemeriksaan Mandiri -->
      <div class="card shadow-sm">
        <div class="card-body p-3">
          <h6 class="mb-2 text-primary fw-bold">üìù Pemeriksaan Mandiri</h6>
          <div
            id="pemeriksaanMandiriWrapper"
            style="max-height: 280px; overflow-y: auto"
          >
            <div class="table-responsive">
              <table
                class="table table-sm table-bordered table-hover align-middle"
                id="pemeriksaanTable"
              >
                <thead class="table-light small">
                  <tr>
                    <th style="width: 70%">Pertanyaan</th>
                    <th style="width: 10%" class="text-center">Jawaban</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- diisi JS -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="text-end mt-2">
            <button id="btnSimpan" class="btn btn-sm btn-success shadow-sm">
              üíæ Simpan Jawaban
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- üîπ Overlay Loading -->
    <div
      id="loadingOverlay"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      "
    >
      <div
        class="spinner-border text-primary"
        role="status"
        style="width: 4rem; height: 4rem"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <footer class="mt-4">
      <p>¬© 2025 Puskesmas Trenggalek | Skrining Kesehatan</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const siswaId = urlParams.get("id");
      const overlay = document.getElementById("loadingOverlay");

      let dataAsli = {};

      async function fetchWithTimeout(resource, options = {}) {
        const { timeout = 7000 } = options;
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        const response = await fetch(resource, {
          ...options,
          signal: controller.signal,
        });
        clearTimeout(id);
        return response;
      }
      let currentStatus = 0; // üîπ global status

      // fungsi animasi wave
      function updateWave() {
        let persen = parseFloat(String(currentStatus).replace(",", ".")) || 0;
        if (persen > 100) persen = 100;

        $("#statusText").text(persen.toFixed(0) + "%");

        const amplitude = 5,
          frequency = 2,
          phase = Date.now() / 500;
        const width = 120,
          height = 120;
        const level = height * (1 - persen / 100);

        let path = "M0 " + height;
        for (let x = 0; x <= width; x++) {
          const y =
            level +
            amplitude * Math.sin((x / width) * frequency * 2 * Math.PI + phase);
          path += ` L${x} ${y}`;
        }
        path += ` L${width} ${height} L0 ${height} Z`;

        $("#wavePath").attr("d", path);

        requestAnimationFrame(updateWave);
      }

      // üîπ fungsi hitung progres dari field
      function hitungProgress() {
        const total = $("#pemeriksaanTable tbody tr").filter(function () {
          return $(this).find("input").length > 0;
        }).length;

        let terisi = 0;
        $("#pemeriksaanTable tbody tr").each(function () {
          if ($(this).find("input[type=number]").val()) terisi++;
          if ($(this).find("input[type=radio]:checked").length > 0) terisi++;
        });

        return total > 0 ? (terisi / total) * 100 : 0;
      }

      // üîπ event listener ‚Üí update status tiap ada perubahan
      $(document).on("input change", "#pemeriksaanTable input", function () {
        currentStatus = hitungProgress();
      });

      // mulai animasi sekali
      updateWave();
      function clearOldCache(currentKey) {
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith("skrining_data_") && key !== currentKey) {
            localStorage.removeItem(key);
          }
        }
      }

      async function loadData() {
        try {
          const siswaId = urlParams.get("id");
          const siswaNama = urlParams.get("nama");
          const siswaKelas = urlParams.get("kelas") || "Kelas 2"; // default ke Kelas 2

          let res;
          const cacheKey = `skrining_data_${siswaKelas}_${siswaId}`; // ‚úÖ cache per siswa
          // üîπ Hapus cache siswa lain
          clearOldCache(cacheKey);

          const cache = localStorage.getItem(cacheKey);

          if (cache) {
            res = JSON.parse(cache);
          } else {
            const response = await fetchWithTimeout(
              "https://script.google.com/macros/s/AKfycbyMNO27yTJNERWL6jsyWQGjdC0--HRofQjecUCeR8PJ9YHk4zgQLL0AQy170-r56aLAJg/exec?kelas=Kelas 2"
            );
            res = await response.json();
            if (res?.success)
              localStorage.setItem(cacheKey, JSON.stringify(res));
          }

          Swal.close();

          if (res?.success) {
            const idx = res.data.findIndex(
              (r) => String(r["No"]).trim() === String(siswaId).trim()
            );

            if (idx === -1) {
              Swal.fire("Data tidak ditemukan", "ID tidak valid.", "warning");
              return;
            }

            const siswa = res.data[idx];

            dataAsli = {
              ...siswa,
              index: idx, // ‚úÖ index baris tersimpan
            };

            // isi biodata
            $("#nama").text(siswa["Nama"] || "-");
            $("#nik").text(siswa["NIK"] || "-");
            // Ganti foto sesuai jenis kelamin
            let jk = (siswa["Jk"] || "").toLowerCase();
            if (jk.includes("p")) {
              $("img[alt='Foto Siswa']").attr("src", "../../assets/woman.png");
            } else {
              $("img[alt='Foto Siswa']").attr("src", "../../assets/man.png");
            }
            if (siswa["Tanggal Lahir"]) {
              let dateObj = new Date(siswa["Tanggal Lahir"]);
              let formatted = dateObj.toLocaleDateString("id-ID", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
              });
              $("#tgl").text(formatted);
            } else {
              $("#tgl").text("-");
            }

            $("#jk").text(siswa["Jk"] || "-");
            $("#ibu").text(siswa["Nama Orang Tua/Wali"] || "-");
            $("#tiket").text(siswa["No Telp"] || "-");

            currentStatus = hitungProgress(); // isi nilai awal

            // hitung umur
            if (siswa["Tanggal Lahir"]) {
              const lahir = new Date(siswa["Tanggal Lahir"]);
              const today = new Date();
              let umur = today.getFullYear() - lahir.getFullYear();
              const bulan = today.getMonth() - lahir.getMonth();
              if (
                bulan < 0 ||
                (bulan === 0 && today.getDate() < lahir.getDate())
              )
                umur--;
              $("#umur").text(umur + " Tahun");
            }
            // generate pertanyaan
            const kategoriMap = {
              "1. Gejala Cemas Remaja": [
                "Dalam 2 minggu terakhir, saya sering merasa khawatir atau tidak tenang, tegang, deg-degan dan gelisah terutama terhadap hal-hal negatif atau yang belum tentu terjadi.¬†*",
                "Dalam 2 minggu terakhir, Saya berpikir berlebihan dan tidak bisa mengendalikan diri, terutama terhadap hal-hal negatif atau yang belum tentu terjadi¬†*",
                "Dalam 2 minggu terakhir, Saya sulit tidur dan berkonsentrasi terutama saat memikirkan hal-hal negatif yang belum tentu terjadi¬†*",
              ],
              "2. Gejala Depresi Remaja": [
                "Dalam 2 minggu terakhir, saya sering merasa sedih atau tertekan padahal tidak ada penyebab yang jelas.¬†*",
                "Dalam 2 minggu terakhir, saya tidak tertarik lagi dengan kegiatan atau hal-hal yang biasanya saya suka.¬†*",
                "Dalam 2 minggu terakhir, saya merasa sering capek, sulit tidur, dan sulit fokus saat belajar atau melakukan kegiatan.¬†*",
              ],
              "3. Kesehatan Reproduksi Putra - Anak Sekolah": [
                "Apakah mengalami gatal-gatal di kemaluan (alat kelamin) atau pernah kencing berwarna kuning kental seperti susu/nanah?¬†*",
                "Apakah mengalami nyeri/ tidak nyaman saat Buang Air Kecil (BAK) atau Buang Air Besar (BAB)?¬†*",
                "Apakah mengalami luka di anus atau dubur?¬†*",
              ],
              "3. Kesehatan Reproduksi Putri - Anak Sekolah": [
                "Apakah sudah mengalami menstruasi?¬†*",
                "Apakah pernah mengalami keputihan? *",
                "Apakah pernah mengalami gatal-gatal di kemaluan? *",
              ],
              "4. Kuesioner Tingkat Aktivitas Fisik - Tingkat Aktivitas Fisik":
                [
                  "Dalam 7 hari terakhir, berapa hari Anda aktif secara fisik dalam waktu total selama minimal 60 menit sehari?¬†*",
                  "Biasanya dalam satu minggu, berapa hari Anda aktif secara fisik dalam waktu total selama minimal 60 menit sehari?¬†*",
                ],
              "5. Kelayakan Tes Kebugaran": [
                "Apakah dokter pernah menyatakan bahwa Anda memiliki masalah pada tulang dan sendi seperti arthritis?¬†*",
                "Apakah dokter pernah menyatakan bahwa Anda memiliki masalah pada jantung dan bahwa anda hanya bisa melakukan aktivitas fisik sesuai anjuran dokter?¬†*",
                "Apakah Anda menderita asma atau pernah terserang asma saat melakukan latihan fisik?¬†*",
                "Apakah Anda pernah kehilangan kesadaran, sakit kepala parah, atau pingsan?¬†*",
              ],
              "6. Penyakit Tropis Terabaikan": [
                "Apakah kulit Anda terdapat bercak putih atau kemerahan yang tidak gatal, mati rasa, tidak sakit dan tidak sembuh dengan obat kulit biasa?¬†*",
                "Apakah kulit Anda ada koreng atau bentol/kudis yang gatal terutama di malam hari walaupun dikasih bedak/lotion?¬†*",
              ],
              "7. Perilaku Merokok - Anak Sekolah": [
                "Apakah Anda merokok dalam setahun terakhir ini?¬†*",
                "Apakah Anda terpapar asap rokok atau menghirup asap rokok dari orang lain dalam sebulan terakhir?¬†*",
              ],
              "8. Faktor Risiko Hepatitis SMP dan SMA": [
                "Apakah Anda pernah menjalani tes untuk Hepatitis B dan mendapatkan hasil positif?¬†*",
                "Apakah Anda memiliki ibu kandung/saudara sekandung yang menderita Hepatitis B?¬†*",
                "Apakah Anda pernah melakukan hubungan intim / seksual dengan orang yang bukan pasangan resmi Anda?¬†*",
                "Apakah Anda pernah menerima transfusi darah sebelumnya?¬†*",
                "Apakah Anda pernah menjalani cuci darah atau hemodialisis?¬†*",
                "Apakah Anda pernah menggunakan narkoba, obat terlarang, atau bahan adiktif lainnya dengan cara disuntik?¬†*",
                "Apakah Anda pernah mendapatkan pengobatan Hepatitis C dan tidak sembuh?¬†*",
              ],
              "9. Talasemia": [
                "Apakah ada anggota keluarga kandung Anda dinyatakan menderita Talasemia, atau kelainan darah atau pernah menjalani transfusi darah secara rutin?¬†*",
                "Apakah ada anggota keluarga kandung Anda dinyatakan sebagai pembawa sifat talasemia (mereka yang memiliki genetik yang tidak normal sehingga berpotensi menurunkan penyakit Talasemia)?¬†*",
              ],
              "10. Skrining Tuberkulosis Anak Sekolah (Kelas 9-12)": [
                "Apakah saat ini Anda sedang batuk- batuk >= 2 minggu?¬†*",
                "Apakah Anda mengalami Berat Badan (BB) turun tanpa penyebab/BB tidak naik/nafsu makan turun?¬†*",
                "Apakah Anda mengalami demam hilang timbul tanpa sebab yang jelas?¬†*",
                "Apakah Anda mengalami berkeringat malam hari tanpa kegiatan?¬†*",
                "Apakah Anda ada kontak dengan pasien Tuberkulosis (TBC)?¬†*",
              ],
              "<p style='color:blue'>üìù*PEMERIKSAAN OLEH NAKES</p>": [],
              "<p style='color:blue'>11. Tekanan Darah (Anak Sekolah)</p>": [
                "Tekanan Darah Sistolik *",
                "Tekanan Darah Diastolik *",
              ],
              "<p style='color:blue'>12. Skrining Gula Darah (Anak Sekolah)</p>":
                ["Gula Darah Sewaktu (GDS)", "HB"],

              "<p style='color:blue'>13. Pemeriksaan Gigi - Anak Sekolah</p>": [
                "Gigi karies",
                "Gigi Hilang / Dicabut*",
              ],
              "<p style='color:blue'>14. Skrining Telinga dan Mata - Anak Sekolah</p>":
                [
                  "Apakah ada gangguan pendengaran di telinga kanan? *",
                  "Apakah ada gangguan pendengaran di telinga kiri? *",
                  "Apakah ada serumen impaksi di telinga kanan? *",
                  "Apakah ada serumen impaksi di telinga kiri? *",
                  "Apakah ada infeksi di telinga kanan? *",
                  "Apakah ada infeksi di telinga kiri? *",
                  "Apakah ditemukan selaput mata merah atau kornea keruh atau kelopak mata ada benjolan atau susah berkedip atau posisi bola mata juling pada mata kanan? *",
                  "Apakah ditemukan selaput mata merah atau kornea keruh atau kelopak mata ada benjolan atau susah berkedip atau posisi bola mata juling pada mata kiri? *",
                  "Hasil Pemeriksaan Visus Mata Kanan *",
                  "Hasil Pemeriksaan Visus Mata Kiri *",
                  "Apakah menggunakan kacamata atau tidak? *",
                ],
              "<p style='color:blue'>15. Hasil Pengukuran Kebugaran Jasmani Anak</p>":
                ["Hasil pemeriksaan kebugaran jasmani anak¬†*"],
              "<p style='color:blue'>16. Pemeriksaan Hepatitis SMP dan SMA</p>":
                [
                  "Hasil Rapid Test Hepatitis B",
                  "Hasil Rapid Test Hepatitis C",
                ],
              "<p style='color:blue'>17. Hasil Pemeriksaan RDT Malaria</p>": [
                "Hasil Pemeriksaan RDT Malaria¬†*",
              ],
            };
            // 2Ô∏è‚É£ Filter sesuai JK
            let pertanyaanKategori = { ...kategoriMap };

            if (jk.includes("p")) {
              // Perempuan ‚Üí hapus putra
              delete pertanyaanKategori[
                "3. Kesehatan Reproduksi Putra - Anak Sekolah"
              ];
            } else {
              // Laki-laki ‚Üí hapus putri
              delete pertanyaanKategori[
                "3. Kesehatan Reproduksi Putri - Anak Sekolah"
              ];
            }

            const tableBody = $("#pemeriksaanTable tbody");
            tableBody.empty();
            let nomorGlobal = 1;

            for (let kategori in pertanyaanKategori) {
              tableBody.append(`
                                    <tr class="table-secondary">
                                      <td colspan="2" style="font-weight:bold;">${kategori}</td>
                                    </tr>
                                  `);

              let nomorSub = 1;
              pertanyaanKategori[kategori].forEach((kolom) => {
                const jawaban = siswa[kolom] || "";
                let inputField = `
                                      <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Ya" ${
                  jawaban === "Ya" ? "checked" : ""
                }>
                                          <label class="form-check-label">Ya</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Tidak" ${
                  jawaban === "Tidak" ? "checked" : ""
                }>
                                          <label class="form-check-label">Tidak</label>
                                        </div>
                                      </div>
                                    `;
                if (kategori.includes("Aktivitas Fisik")) {
                  inputField = `
                                        <div class="d-flex align-items-center">
                                          <input type="number"  class="form-control"
                                            name="q${nomorGlobal}" value="${jawaban}" style="width:80px;">
                                          <span class="ms-2">(hari) *</span>
                                        </div>
                                      `;
                }
                if (kategori.includes("Tekanan Darah (Anak Sekolah)")) {
                  if (kolom.includes("Tekanan Darah Sistolik *")) {
                    inputField = `
                                        <div class="d-flex align-items-center">
                                          <input type="number"  class="form-control"
                                            name="q${nomorGlobal}" value="${jawaban}" style="width:80px;">
                                          <span class="ms-2">mmHg *</span>
                                        </div>
                                      `;
                  } else if (kolom.includes("Tekanan Darah Diastolik *")) {
                    inputField = `
                                        <div class="d-flex align-items-center">
                                          <input type="number"  class="form-control"
                                            name="q${nomorGlobal}" value="${jawaban}" style="width:80px;">
                                          <span class="ms-2">mmHg *</span>
                                        </div>
                                      `;
                  }
                }
                if (kategori.includes("Skrining Gula Darah (Anak Sekolah)")) {
                  if (kolom.includes("Gula Darah Sewaktu (GDS)")) {
                    inputField = `
                                         <div class="d-flex align-items-center">
                                          <input type="number"  class="form-control"
                                            name="q${nomorGlobal}" value="${jawaban}" style="width:80px;">
                                          <span class="ms-2">(mg/dl) *</span>
                                        </div>
                                      `;
                  } else if (kolom.includes("HB")) {
                    inputField = `
                                        <div class="d-flex align-items-center">
                                          <input type="number"  class="form-control"
                                            name="q${nomorGlobal}" value="${jawaban}" style="width:80px;">
                                          <span class="ms-2">(mg/dl) *</span>
                                        </div>
                                      `;
                  }
                }

                if (kategori.includes("Pemeriksaan Gigi - Anak Sekolah")) {
                  if (kolom.includes("Gigi karies")) {
                    inputField = `
                                        <div class="d-flex justify-content-around">
                                          <div class="d-flex align-items-center">
                                            <input type="number"  class="form-control"
                                              name="q${nomorGlobal}" value="${jawaban}" style="width:80px;">
                                            <span class="ms-2"></span>
                                          </div>
                                          <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Dirujuk" ${
                      jawaban === "Dirujuk" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Dirujuk</label>
                                        </div>
                                        </div>
                                      `;
                  } else if (kolom.includes("Gigi Hilang / Dicabut*")) {
                    inputField = `
                                         <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Ya" ${
                      jawaban === "Ya" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Ya</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Tidak" ${
                      jawaban === "Tidak" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Tidak</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Dirujuk" ${
                      jawaban === "Dirujuk" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Dirujuk</label>
                                        </div>
                                      </div>
                                      </div>

                                      `;
                  }
                }
                if (
                  kategori.includes("Skrining Telinga dan Mata - Anak Sekolah")
                ) {
                  if (
                    kolom.includes(
                      "Apakah ada gangguan pendengaran di telinga kanan? *"
                    )
                  ) {
                    inputField = `
                                       <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Normal" ${
                      jawaban === "Normal" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Normal</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Ada indikasi gangguan pendengaran" ${
                      jawaban === "Ada indikasi gangguan pendengaran"
                        ? "checked"
                        : ""
                    }>
                                          <label class="form-check-label">Ada indikasi gangguan pendengaran</label>
                                        </div>
                                       </div>
                                      `;
                  } else if (
                    kolom.includes(
                      "Apakah ada gangguan pendengaran di telinga kiri? *"
                    )
                  ) {
                    inputField = `
                                        <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Normal" ${
                      jawaban === "Normal" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Normal</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Ada indikasi gangguan pendengaran" ${
                      jawaban === "Ada indikasi gangguan pendengaran"
                        ? "checked"
                        : ""
                    }>
                                          <label class="form-check-label">Ada indikasi gangguan pendengaran</label>
                                        </div>
                                       </div>
                                      `;
                  } else if (
                    kolom.includes(
                      "Apakah ada serumen impaksi di telinga kanan? *"
                    )
                  ) {
                    inputField = `
                                         <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Tidak ada serumen impaksi" ${
                      jawaban === "Tidak ada serumen impaksi" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Tidak ada serumen impaksi</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Ada serumen impaksi" ${
                      jawaban === "Ada serumen impaksi" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Ada serumen impaksi</label>
                                        </div>
                                       </div>
                                      `;
                  } else if (
                    kolom.includes(
                      "Apakah ada serumen impaksi di telinga kiri? *"
                    )
                  ) {
                    inputField = `
                                        <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Tidak ada serumen impaksi" ${
                      jawaban === "Tidak ada serumen impaksi" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Tidak ada serumen impaksi</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Ada serumen impaksi" ${
                      jawaban === "Ada serumen impaksi" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Ada serumen impaksi</label>
                                        </div>
                                       </div>
                                      `;
                  } else if (
                    kolom.includes("Apakah ada infeksi di telinga kanan? *")
                  ) {
                    inputField = `
                                       <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Tidak ada Infeksi Telinga" ${
                      jawaban === "Tidak ada Infeksi Telinga" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Tidak ada Infeksi Telinga</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Ada Infeksi Telinga" ${
                      jawaban === "Ada Infeksi Telinga" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Ada Infeksi Telinga</label>
                                        </div>
                                       </div>
                                      `;
                  } else if (
                    kolom.includes("Apakah ada infeksi di telinga kiri? *")
                  ) {
                    inputField = `
                                         <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Tidak ada Infeksi Telinga" ${
                      jawaban === "Tidak ada Infeksi Telinga" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Tidak ada Infeksi Telinga</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Ada Infeksi Telinga" ${
                      jawaban === "Ada Infeksi Telinga" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Ada Infeksi Telinga</label>
                                        </div>
                                       </div>
                                      `;
                  } else if (
                    kolom.includes(
                      "Apakah ditemukan selaput mata merah atau kornea keruh atau kelopak mata ada benjolan atau susah berkedip atau posisi bola mata juling pada mata kanan? *"
                    )
                  ) {
                    inputField = `
                                         <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Ya" ${
                      jawaban === "Ya" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Ya</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Tidak" ${
                      jawaban === "Tidak" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Tidak</label>
                                        </div>
                                       </div>
                                      `;
                  } else if (
                    kolom.includes(
                      "Apakah ditemukan selaput mata merah atau kornea keruh atau kelopak mata ada benjolan atau susah berkedip atau posisi bola mata juling pada mata kiri? *"
                    )
                  ) {
                    inputField = `
                                         <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Ya" ${
                      jawaban === "Ya" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Ya</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Tidak" ${
                      jawaban === "Tidak" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Tidak</label>
                                        </div>
                                       </div>
                                      `;
                  } else if (
                    kolom.includes("Hasil Pemeriksaan Visus Mata Kanan *")
                  ) {
                    inputField = `
                                         <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Visus 6/6 - 6/9" ${
                      jawaban === "Visus 6/6 - 6/9" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Visus 6/6 - 6/9</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Visus <6/9" ${
                      jawaban === "Visus <6/9" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Visus <6/9</label>
                                        </div>
                                       </div>
                                      `;
                  } else if (
                    kolom.includes("Hasil Pemeriksaan Visus Mata Kiri *")
                  ) {
                    inputField = `
                                         <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Visus 6/6 - 6/9" ${
                      jawaban === "Visus 6/6 - 6/9" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Visus 6/6 - 6/9</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Visus <6/9" ${
                      jawaban === "Visus <6/9" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Visus <6/9</label>
                                        </div>
                                       </div>
                                      `;
                  }
                }
                if (
                  kategori.includes("Hasil Pengukuran Kebugaran Jasmani Anak")
                ) {
                  inputField = `
                                          <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Baik" ${
                    jawaban === "Baik" ? "checked" : ""
                  }>
                                          <label class="form-check-label">Baik</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Cukup" ${
                    jawaban === "Cukup" ? "checked" : ""
                  }>
                                          <label class="form-check-label">Cukup</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Kurang" ${
                    jawaban === "Kurang" ? "checked" : ""
                  }>
                                          <label class="form-check-label">Kurang</label>
                                        </div>
                                       </div>
                                      `;
                }

                if (kategori.includes("Pemeriksaan Hepatitis SMP dan SMA")) {
                  if (kolom.includes("Hasil Rapid Test Hepatitis B")) {
                    inputField = `
                                         <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="HBsAg Non Reaktif" ${
                      jawaban === "HBsAg Non Reaktif" ? "checked" : ""
                    }>
                                          <label class="form-check-label">HBsAg Non Reaktif</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="HBsAg Reaktif" ${
                      jawaban === "HBsAg Reaktif" ? "checked" : ""
                    }>
                                          <label class="form-check-label">HBsAg Reaktif</label>
                                        </div>
                                       </div>
                                      `;
                  } else if (kolom.includes("Hasil Rapid Test Hepatitis C")) {
                    inputField = `
                                         <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Anti HCV Non Reaktif" ${
                      jawaban === "Anti HCV Non Reaktif" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Anti HCV Non Reaktif</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Anti HCV Reaktif" ${
                      jawaban === "Anti HCV Reaktif" ? "checked" : ""
                    }>
                                          <label class="form-check-label">Anti HCV Reaktif</label>
                                        </div>
                                       </div>
                                      `;
                  }
                }
                if (kategori.includes("Hasil Pemeriksaan RDT Malaria")) {
                  inputField = `
                                         <div class="d-flex justify-content-around">
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Reaktif" ${
                    jawaban === "Reaktif" ? "checked" : ""
                  }>
                                          <label class="form-check-label">Reaktif</label>
                                        </div>
                                        <div class="form-check">
                                          <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Non-Reaktif" ${
                    jawaban === "Non-Reaktif" ? "checked" : ""
                  }>
                                          <label class="form-check-label">Non-Reaktif</label>
                                        </div>
                                       </div>
                                      `;
                }
                tableBody.append(`
                                      <tr>
                                        <td style="padding-left:20px;">${nomorSub}. ${kolom}</td>
                                        <td style="width:10%;">${inputField}</td>
                                      </tr>
                                    `);
                nomorSub++;
                nomorGlobal++;
              });
            }
            // ... (kode kategoriMap & generate pertanyaan tetap sama)
          } else {
            Swal.fire(
              "Gagal memuat",
              (res && res.message) || "Coba lagi nanti.",
              "error"
            );
          }
        } catch (err) {
          console.error(err);
          if (overlay) {
            overlay.innerHTML = `<div class="text-center fw-bold text-danger">
                          ‚ùå ${err.message}
                        </div>`;
          }
        } finally {
          // üîπ sembunyikan overlay setelah 500ms
          if (overlay) {
            setTimeout(() => {
              overlay.style.display = "none";
            }, 500);
          }
        }
      }

      loadData();
      // di akhir loadData()
      currentStatus = hitungProgress();

      // tombol simpan
      $("#btnSimpan").on("click", async function () {
        const data = { ...dataAsli };

        $("#pemeriksaanTable tbody tr").each(function () {
          if ($(this).find("input").length === 0) return;

          const pertanyaan = $(this)
            .find("td:first")
            .text()
            .replace(/^\d+\.\s*/, "")
            .trim();
          if (pertanyaan === "BS") return false; // stop loop setelah BS
          let jawaban = "";

          if ($(this).find("input[type=number]").length > 0) {
            jawaban = $(this).find("input[type=number]").val() || "";
          } else if ($(this).find("input[type=radio]:checked").length > 0) {
            jawaban = $(this).find("input[type=radio]:checked").val() || "";
          }

          if (pertanyaan) data[pertanyaan] = jawaban;
        });

        data["kelas"] = "Kelas 2";
        data["action"] = "edit";
        data["index"] = dataAsli.index; // ‚úÖ tambahkan index agar tidak error

        Swal.fire({
          title: "Menyimpan...",
          text: "Mohon tunggu sebentar",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        try {
          const response = await fetch(
            "https://script.google.com/macros/s/AKfycbyMNO27yTJNERWL6jsyWQGjdC0--HRofQjecUCeR8PJ9YHk4zgQLL0AQy170-r56aLAJg/exec?kelas=Kelas 2",
            { method: "POST", body: new URLSearchParams(data) }
          );
          const json = await response.json();

          if (json?.success) {
            Swal.fire("‚úÖ Sukses", "Data berhasil diperbarui!", "success");
            localStorage.removeItem("skrining_data_" + siswaId);
            if (data["status"]) updateWave(data["status"]);
          } else {
            Swal.fire(
              "‚ö† Gagal",
              json?.message || "Terjadi kesalahan.",
              "error"
            );
          }
        } catch (err) {
          Swal.fire("‚ö† Error", "Tidak bisa menyimpan data.", "error");
          console.error(err);
        }
      });
    </script>
  </body>
</html>

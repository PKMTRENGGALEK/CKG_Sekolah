<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Skrining CKG</title>

    <!-- Bootstrap & DataTables -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
      table#dataTable {
        font-size: 0.8rem;
      }

      .btn-xs {
        padding: 0.1rem 0.35rem;
        font-size: 0.7rem;
        line-height: 1;
      }

      th, td {
        vertical-align: middle !important;
      }
      th.hide-col, td.hide-col {
    display: none;
  }
      body {
        padding-top: 70px;
        padding-bottom: 60px;
        background-color: #f8f9fa;
      }
      .table-sm td,
      .table-sm th {
        font-size: 12px !important;
      }
      thead th {
        /*position: sticky;*/
        top: 0;
        background-color: #212529;
        color: white;
        z-index: 2;
      }
      #signaturePad {
        touch-action: none;
        cursor: crosshair;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-light bg-white bg-gradient fixed-top shadow">
      <div class="container d-flex justify-content-between align-items-center">
        <span class="navbar-brand mb-0 h5 text-success">
          <i class="bi bi-bar-chart-line"></i> Register PKG Siswa Sekolah Dasar
          Negeri 1 Karangsoko
        </span>
        <button
          onclick="history.back()"
          class="btn btn-outline-secondary btn-sm"
        >
          <i class="bi bi-arrow-left-circle"></i> Kembali
        </button>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- Header + Button -->
      <div
        class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"
      >
        <h4 class="text-success mb-0">
          <u>Data Siswa Kelas 1 </u>
        </h4>
        <div class="d-flex gap-2">
          <button
            class="btn btn-sm btn-outline-success shadow"
            id="importExcelBtn"
          >
            <i class="bi bi-upload"></i> Import Excel
          </button>
          <a
            href="https://docs.google.com/spreadsheets/d/15KEVkDJ0hOUj8W3XXmeSmeyeRpoxAW4KAyxZtyisFnY/edit?usp=sharing"
            target="_blank"
            class="btn btn-outline-danger btn-sm shadow"
          >
            <i class="bi bi-file-earmark-richtext"></i> View Source Data
          </a>
        </div>
      </div>

      <!-- Tabel -->
      <div class="card shadow">
        <div class="card-body">
          <div class="table-responsive">
            <table id="dataTable" class="table table-sm table-bordered w-100">
              <thead id="tableHead" class="table-success bg-gradient"></thead>
              <tbody id="tableBody">
                <tr class="text-center">
                  <td colspan="100%">
                    <div
                      class="spinner-border text-primary"
                      role="status"
                    ></div>
                    <div>Memuat data...</div>
                  </td>
                </tr>
              </tbody>
              </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Detail Data  -->
    <div class="modal fade" id="detailModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detail Skrining</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div id="detailContent"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal TTD -->
    <div class="modal fade" id="ttdModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form id="ttdForm">
            <div class="modal-header">
              <h5 class="modal-title">Tanda Tangan Siswa</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <canvas
                id="signaturePad"
                style="border: 1px solid #ccc; width: 100%; height: 150px"
              ></canvas>
              <button
                type="button"
                class="btn btn-sm btn-secondary mt-2"
                id="clearBtn"
              >
                Bersihkan
              </button>
            </div>
            <div class="modal-footer">
              <input type="hidden" id="rowIndex" />
              <button type="submit" class="btn btn-primary">Simpan TTD</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <input
      type="file"
      id="excelFileInput"
      accept=".xlsx, .xls"
      style="display: none"
    />

    <!-- Footer -->
    <footer class="bg-light text-dark text-center py-2 fixed-bottom">
      <div class="container">
        &copy; 2025 Puskesmas Trenggalek | Aplikasi Skrining Siswa
      </div>
    </footer>

    <!-- Script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>



<script>
  const kelas = "Kelas 1";
  const scriptURL =
    "https://script.google.com/macros/s/AKfycbxsLpMVW96v_64uSzoMhdneojAd_9sWraGc5VqOT5LWVY-wkcjzyxU5kSOarPm_Yn7P6Q/exec";
  const getScriptURL = () => `${scriptURL}?kelas=${encodeURIComponent(kelas)}`;
  let globalData = [];

  const mandiriFields = ["Tinggi", "Berat", "Lingkar Perut", "Lingkar Lengan"];

  const detailFields = [
    "Risiko Tuberkulosis",
    "Gejala DM Anak",
    "Risiko Kesehatan Jiwa",
    "Kesehatan Reproduksi (Kelas 4-6)",
    "Perilaku Merokok",
    "Risiko Hepatitis B",
    "Riwayat Imunisasi Rutin Lengkap",
    "Aktivitas Fisik  kelas 4-6*",
    "PAR-Q",
  ];

  function formatValue(value, header) {
    if (typeof value === "string" && value.match(/^\d{4}-\d{2}-\d{2}T/)) {
      const date = new Date(value);
      return date.toLocaleDateString("id-ID");
    }
    return value;
  }

  window.showDetail = function (index) {
    const row = globalData[index];
    let html = `<form id="editForm"><table class='table table-bordered table-sm'>`;

    detailFields.forEach((field) => {
      const value = row[field] || "";
      html += `<tr><th>${field}</th><td>`;

      const optionsYaTidak = ["Ya", "Tidak", ""];

      if (optionsYaTidak.includes(value)) {
        optionsYaTidak.forEach((opt) => {
          html += `
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="${field}" value="${opt}" ${value === opt ? "checked" : ""}>
              <label class="form-check-label">${opt || "Kosong"}</label>
            </div>`;
        });
      } else if (!isNaN(value) && Number(value) >= 0 && Number(value) <= 10) {
        for (let i = 0; i <= 10; i++) {
          html += `
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="${field}" value="${i}" ${Number(value) === i ? "checked" : ""}>
              <label class="form-check-label">${i}</label>
            </div>`;
        }
      } else {
        html += `<input type="text" class="form-control form-control-sm" name="${field}" value="${value}">`;
      }

      html += `</td></tr>`;
    });

    html += `</table></form>
    <div class="text-end">
      <button type="button" class="btn btn-success btn-sm" onclick="submitEdit(${index})">
        <i class="bi bi-save"></i> Simpan Perubahan
      </button>
    </div>`;

    document.getElementById("detailContent").innerHTML = html;
    new bootstrap.Modal(document.getElementById("detailModal")).show();
  };

  window.showMandiri = function (index) {
    const row = globalData[index];
    let html = `<form id="mandiriForm"><table class='table table-bordered table-sm'>`;

    mandiriFields.forEach((field) => {
      const value = row[field] || "";
      html += `<tr><th>${field}</th><td><input type="text" class="form-control form-control-sm" name="${field}" value="${value}"></td></tr>`;
    });

    html += `</table></form>
    <div class="text-end">
      <button type="button" class="btn btn-primary btn-sm" onclick="submitMandiri(${index})">
        <i class="bi bi-save"></i> Simpan Data
      </button>
    </div>`;

    document.getElementById("detailContent").innerHTML = html;
    new bootstrap.Modal(document.getElementById("detailModal")).show();
  };

  window.submitMandiri = async function (index) {
    const formEl = document.getElementById("mandiriForm");
    const formData = new FormData(formEl);
    const row = globalData[index];
    const payload = new URLSearchParams();

    Object.keys(row).forEach((k) => {
      if (!mandiriFields.includes(k)) payload.append(k, row[k]);
    });

    mandiriFields.forEach((field) => {
      payload.append(field, formData.get(field));
    });

    payload.append("action", "edit");
    payload.append("index", index);
    payload.append("kelas", kelas);

    Swal.fire({
      title: "Menyimpan...",
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading(),
    });

    try {
      const res = await fetch(scriptURL, { method: "POST", body: payload });
      const result = await res.json();
      Swal.fire("Berhasil", result.message || "Data berhasil disimpan!", "success").then(() => location.reload());
    } catch {
      Swal.fire("Gagal", "Gagal menyimpan data!", "error");
    }
  };

  async function loadData() {
    try {
      const res = await fetch(getScriptURL());
      const result = await res.json();
      globalData = result.data || result;

      const headers = (result.headers || Object.keys(globalData[0] || {})).filter(
        (h) => h !== "TTD" && h !== "Kelas" && !detailFields.includes(h)
      );
      const tableHead = document.getElementById("tableHead");
      const tableBody = document.getElementById("tableBody");
      tableHead.innerHTML = "";
      tableBody.innerHTML = "";

      if (globalData.length === 0) {
        tableHead.innerHTML = "<tr><th class='text-center'>Info</th></tr>";
        tableBody.innerHTML =
          "<tr><td class='text-center text-muted'>Data kosong</td></tr>";
        return;
      }

      const headRow = document.createElement("tr");
      headers.forEach((h) => {
        const th = document.createElement("th");
        th.textContent = h;
        if (h === "Nama") th.style.minWidth = "180px";
        headRow.appendChild(th);
      });
      headRow.innerHTML += "<th>Skrining Mandiri</th><th>Detail Skrining</th><th>Aksi</th>";
      tableHead.appendChild(headRow);

      globalData.forEach((row, i) => {
        const tr = document.createElement("tr");
        headers.forEach((h) => {
          const td = document.createElement("td");
          td.innerHTML = formatValue(row[h], h);
          tr.appendChild(td);
        });

        tr.innerHTML += `
          <td><button class='btn btn-outline-secondary btn-xs' onclick='showMandiri(${i})'><i class="bi bi-person-vcard"></i> Mandiri</button></td>
          <td><button class='btn btn-outline-info btn-xs' onclick='showDetail(${i})'><i class="bi bi-eye"></i> View</button></td>
          <td>${row["TTD"] && row["TTD"].startsWith("http") ? `<a href="${row["TTD"]}" class='btn btn-sm btn-outline-warning' target="_blank"><i class="bi bi-vector-pen"></i></a>` : `<button class="btn btn-sm btn-outline-success" onclick="openTTDModal(${i})">TTD</button>`}</td>
        `;

        tableBody.appendChild(tr);
      });

      $("#dataTable").DataTable({
        destroy: true,
        responsive: true,
        paging: false,
        searching: true,
        order: [],
        language: {
          url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/id.json",
        },
        columnDefs: [{ targets: "_all", className: "text-center" }],
      });
    } catch (error) {
      console.error(error);
      Swal.fire("Gagal", "Gagal memuat data. Periksa koneksi atau scriptURL.", "error");
    }
  }

  loadData();
</script>



  </body>
</html>

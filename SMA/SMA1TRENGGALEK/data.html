<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Individu - Skrining Kesehatan</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      body {
        background: linear-gradient(135deg, #e0f2fe, #fef9c3);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding-bottom: 60px;
        font-size: 14px;
      }
      .header {
        text-align: center;
        padding: 20px;
        color: #3b5208;
        font-weight: bold;
      }
      .card-profile {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }
      .pemeriksaan {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      footer {
        position: relative;
        background: transparent;
        color: #333;
        text-align: center;
        padding: 15px 0;
        margin-top: auto;
      }
      footer p {
        margin: 0;
        font-size: 0.9rem;
      }
      #pemeriksaanTable td {
        vertical-align: top;
        padding: 0.5rem 0.75rem;
      }
      #pemeriksaanTable .form-check {
        margin-right: 1rem;
      }
      #pemeriksaanTable tr:hover {
        background-color: #f9f9f9;
      }
      .progress-container {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto;
        border-radius: 50%;
        background: #eee;
        overflow: hidden;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
      }

      .progress-container {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto;
        border-radius: 50%;
        background: #eee;
        overflow: hidden;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
      }

      .wave-svg {
        width: 80px;
        height: 80px;
        overflow: visible;
      }
      .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        font-size: 1.2rem;
        color: #333;
      }

      /* animasi horizontal tetap */
      @keyframes waveMove {
        0% {
          transform: translateX(-25%);
        }
        100% {
          transform: translateX(25%);
        }
      }
    </style>
  </head>
  <body>
    <!-- <div class="container mt-2">
    <a href="skrining-x.html" class="btn btn-secondary mb-2 shadow">‚¨Ö Kembali</a>
  </div> -->
    <div class="header">
      <h3>ü©∫ Cek Kesehatan Anak Sekolah</h3>
    </div>

    <div class="container">
      <!-- Profil Siswa -->

      <div class="card-profile">
        <div class="row align-items-center">
          <!-- Biodata -->
          <div class="col-md-8">
            <h6 class="fw-bold text-primary mb-3">üìã Biodata</h6>
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between">
                <span class="fw-semibold">Nama</span>
                <span id="nama" class="text-muted">-</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span class="fw-semibold">NIK</span>
                <span id="nik" class="text-muted">-</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span class="fw-semibold">Tanggal Lahir</span>
                <span id="tgl" class="text-muted">-</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span class="fw-semibold">Umur</span>
                <span id="umur" class="text-muted">-</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span class="fw-semibold">Jenis Kelamin</span>
                <span id="jk" class="text-muted">-</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span class="fw-semibold">Nama Ibu/Wali</span>
                <span id="ibu" class="text-muted">-</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span class="fw-semibold">Nomor Telepon</span>
                <span id="tiket" class="text-muted">-</span>
              </li>
            </ul>
          </div>

          <!-- Foto & Progress -->
          <div class="col-md-4 text-center">
            <img
              src="https://pkmtrenggalek.github.io/CKG_Sekolah/SMA/3b48356f-6b37-4dd0-83ed-4b3c4b1e020b.png"
              alt="Foto Siswa"
              class="img-fluid rounded shadow-sm mb-3"
              style="max-width: 120px"
            />

            <div class="progress-container mb-2">
              <svg viewBox="0 0 120 120" class="wave-svg">
                <path id="wavePath" fill="#4facfe"></path>
              </svg>
              <div class="progress-text" id="statusText">0%</div>
            </div>
            <span class="text-primary fw-semibold"
              >Keterselesaian Skrining</span
            >
          </div>
        </div>
      </div>

      <!-- Pemeriksaan Mandiri -->
      <div class="card mt-4">
        <div class="card-body">
          <h5 class="mb-3 text-primary">üìù Pemeriksaan Mandiri</h5>
          <div class="table-responsive">
            <table
              class="table table-bordered table-hover"
              id="pemeriksaanTable"
            >
              <thead class="table-light">
                <tr>
                  <th style="width: 70%">Pertanyaan</th>
                  <th style="width: 10%" class="text-center">Jawaban</th>
                </tr>
              </thead>
              <tbody>
                <!-- baris akan diisi oleh JS -->
              </tbody>
            </table>
          </div>
          <div class="text-end mt-3">
            <button id="btnSimpan" class="btn btn-success">
              üíæ Simpan Jawaban
            </button>

            <!-- <a href="index.html" class="btn btn-secondary">‚¨Ö Kembali</a> -->
          </div>
        </div>
      </div>
    </div>

    <footer class="fixed-bottom">
      <p>¬© 2025 Puskesmas Trenggalek | Skrining Kesehatan</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const siswaId = urlParams.get("id");
      let dataAsli = {};

      async function fetchWithTimeout(resource, options = {}) {
        const { timeout = 7000 } = options;
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        const response = await fetch(resource, {
          ...options,
          signal: controller.signal,
        });
        clearTimeout(id);
        return response;
      }
      let currentStatus = 0; // üîπ global status

      // fungsi animasi wave
      function updateWave() {
        let persen = parseFloat(String(currentStatus).replace(",", ".")) || 0;
        if (persen > 100) persen = 100;

        $("#statusText").text(persen.toFixed(0) + "%");

        const amplitude = 5,
          frequency = 2,
          phase = Date.now() / 500;
        const width = 120,
          height = 120;
        const level = height * (1 - persen / 100);

        let path = "M0 " + height;
        for (let x = 0; x <= width; x++) {
          const y =
            level +
            amplitude * Math.sin((x / width) * frequency * 2 * Math.PI + phase);
          path += ` L${x} ${y}`;
        }
        path += ` L${width} ${height} L0 ${height} Z`;

        $("#wavePath").attr("d", path);

        requestAnimationFrame(updateWave);
      }

      // üîπ fungsi hitung progres dari field
      function hitungProgress() {
        const total = $("#pemeriksaanTable tbody tr").filter(function () {
          return $(this).find("input").length > 0;
        }).length;

        let terisi = 0;
        $("#pemeriksaanTable tbody tr").each(function () {
          if ($(this).find("input[type=number]").val()) terisi++;
          if ($(this).find("input[type=radio]:checked").length > 0) terisi++;
        });

        return total > 0 ? (terisi / total) * 100 : 0;
      }

      // üîπ event listener ‚Üí update status tiap ada perubahan
      $(document).on("input change", "#pemeriksaanTable input", function () {
        currentStatus = hitungProgress();
      });

      // mulai animasi sekali
      updateWave();

      async function loadData() {
        try {
          let res;
          const cacheKey = "skrining_data_" + siswaId; // ‚úÖ cache per siswa
          const cache = localStorage.getItem(cacheKey);

          if (cache) {
            res = JSON.parse(cache);
          } else {
            const response = await fetchWithTimeout(
              "https://script.google.com/macros/s/AKfycbxvijgSaKZqTv2I84_wGTL3LTM3MqaPUQY8GNoKc3qvE6y94hI07yI37LxpbijoE6KM/exec?kelas=Kelas 1"
            );
            res = await response.json();
            if (res?.success)
              localStorage.setItem(cacheKey, JSON.stringify(res));
          }

          Swal.close();

          if (res?.success) {
            const idx = res.data.findIndex(
              (r) => String(r["No"]).trim() === String(siswaId).trim()
            );

            if (idx === -1) {
              Swal.fire("Data tidak ditemukan", "ID tidak valid.", "warning");
              return;
            }

            const siswa = res.data[idx];

            dataAsli = {
              ...siswa,
              index: idx, // ‚úÖ index baris tersimpan
            };

            // isi biodata
            $("#nama").text(siswa["Nama"] || "-");
            $("#nik").text(siswa["NIK"] || "-");

            if (siswa["Tanggal Lahir"]) {
              let dateObj = new Date(siswa["Tanggal Lahir"]);
              let formatted = dateObj.toLocaleDateString("id-ID", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
              });
              $("#tgl").text(formatted);
            } else {
              $("#tgl").text("-");
            }

            $("#jk").text(siswa["Jk"] || "-");
            $("#ibu").text(siswa["Nama Orang Tua/Wali"] || "-");
            $("#tiket").text(siswa["No Telp"] || "-");

            updateWave(siswa["status"]);

            // hitung umur
            if (siswa["Tanggal Lahir"]) {
              const lahir = new Date(siswa["Tanggal Lahir"]);
              const today = new Date();
              let umur = today.getFullYear() - lahir.getFullYear();
              const bulan = today.getMonth() - lahir.getMonth();
              if (
                bulan < 0 ||
                (bulan === 0 && today.getDate() < lahir.getDate())
              )
                umur--;
              $("#umur").text(umur + " Tahun");
            }
            // generate pertanyaan
            const kategoriMap = {
              "1. Gejala Cemas Remaja": [
                "Dalam 2 minggu terakhir, saya sering merasa khawatir atau tidak tenang, tegang, deg-degan dan gelisah terutama terhadap hal-hal negatif atau yang belum tentu terjadi.¬†*",
                "Dalam 2 minggu terakhir, Saya berpikir berlebihan dan tidak bisa mengendalikan diri, terutama terhadap hal-hal negatif atau yang belum tentu terjadi¬†*",
                "Dalam 2 minggu terakhir, Saya sulit tidur dan berkonsentrasi terutama saat memikirkan hal-hal negatif yang belum tentu terjadi¬†*",
              ],
              "2. Gejala Depresi Remaja": [
                "Dalam 2 minggu terakhir, saya sering merasa sedih atau tertekan padahal tidak ada penyebab yang jelas.¬†*",
                "Dalam 2 minggu terakhir, saya tidak tertarik lagi dengan kegiatan atau hal-hal yang biasanya saya suka.¬†*",
                "Dalam 2 minggu terakhir, saya merasa sering capek, sulit tidur, dan sulit fokus saat belajar atau melakukan kegiatan.¬†*",
              ],
              "3. Kesehatan Reproduksi Putra - Anak Sekolah": [
                "Apakah mengalami gatal-gatal di kemaluan (alat kelamin) atau pernah kencing berwarna kuning kental seperti susu/nanah?¬†*",
                "Apakah mengalami nyeri/ tidak nyaman saat Buang Air Kecil (BAK) atau Buang Air Besar (BAB)?¬†*",
                "Apakah mengalami luka di anus atau dubur?¬†*",
              ],
              "4. Kuesioner Tingkat Aktivitas Fisik - Tingkat Aktivitas Fisik":
                [
                  "Dalam 7 hari terakhir, berapa hari Anda aktif secara fisik dalam waktu total selama minimal 60 menit sehari?¬†*",
                  "Biasanya dalam satu minggu, berapa hari Anda aktif secara fisik dalam waktu total selama minimal 60 menit sehari?¬†*",
                ],
              "5. Kelayakan Tes Kebugaran": [
                "Apakah dokter pernah menyatakan bahwa Anda memiliki masalah pada tulang dan sendi seperti arthritis?¬†*",
                "Apakah dokter pernah menyatakan bahwa Anda memiliki masalah pada jantung dan bahwa anda hanya bisa melakukan aktivitas fisik sesuai anjuran dokter?¬†*",
                "Apakah Anda menderita asma atau pernah terserang asma saat melakukan latihan fisik?¬†*",
                "Apakah Anda pernah kehilangan kesadaran, sakit kepala parah, atau pingsan?¬†*",
              ],
              "6. Penyakit Tropis Terabaikan": [
                "Apakah kulit Anda terdapat bercak putih atau kemerahan yang tidak gatal, mati rasa, tidak sakit dan tidak sembuh dengan obat kulit biasa?¬†*",
                "Apakah kulit Anda ada koreng atau bentol/kudis yang gatal terutama di malam hari walaupun dikasih bedak/lotion?¬†*",
              ],
              "7. Perilaku Merokok - Anak Sekolah": [
                "Apakah Anda merokok dalam setahun terakhir ini?¬†*",
                "Apakah Anda terpapar asap rokok atau menghirup asap rokok dari orang lain dalam sebulan terakhir?¬†*",
              ],
              "8. Faktor Risiko Hepatitis SMP dan SMA": [
                "Apakah Anda pernah menjalani tes untuk Hepatitis B dan mendapatkan hasil positif?¬†*",
                "Apakah Anda memiliki ibu kandung/saudara sekandung yang menderita Hepatitis B?¬†*",
                "Apakah Anda pernah melakukan hubungan intim / seksual dengan orang yang bukan pasangan resmi Anda?¬†*",
                "Apakah Anda pernah menerima transfusi darah sebelumnya?¬†*",
                "Apakah Anda pernah menjalani cuci darah atau hemodialisis?¬†*",
                "Apakah Anda pernah menggunakan narkoba, obat terlarang, atau bahan adiktif lainnya dengan cara disuntik?¬†*",
                "Apakah Anda pernah mendapatkan pengobatan Hepatitis C dan tidak sembuh?¬†*",
              ],
              "9. Talasemia": [
                "Apakah ada anggota keluarga kandung Anda dinyatakan menderita Talasemia, atau kelainan darah atau pernah menjalani transfusi darah secara rutin?¬†*",
                "Apakah ada anggota keluarga kandung Anda dinyatakan sebagai pembawa sifat talasemia (mereka yang memiliki genetik yang tidak normal sehingga berpotensi menurunkan penyakit Talasemia)?¬†*",
              ],
              "10. Skrining Tuberkulosis Anak Sekolah (Kelas 9-12)": [
                "Apakah saat ini Anda sedang batuk- batuk >= 2 minggu?¬†*",
                "Apakah Anda mengalami Berat Badan (BB) turun tanpa penyebab/BB tidak naik/nafsu makan turun?¬†*",
                "Apakah Anda mengalami demam hilang timbul tanpa sebab yang jelas?¬†*",
                "Apakah Anda mengalami berkeringat malam hari tanpa kegiatan?¬†*",
                "Apakah Anda ada kontak dengan pasien Tuberkulosis (TBC)?¬†*",
              ],
            };

            const tableBody = $("#pemeriksaanTable tbody");
            tableBody.empty();
            let nomorGlobal = 1;

            for (let kategori in kategoriMap) {
              tableBody.append(`
                  <tr class="table-secondary">
                    <td colspan="2" style="font-weight:bold;">${kategori}</td>
                  </tr>
                `);

              let nomorSub = 1;
              kategoriMap[kategori].forEach((kolom) => {
                const jawaban = siswa[kolom] || "";
                let inputField = `
                    <div class="d-flex justify-content-around">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Ya" ${
                  jawaban === "Ya" ? "checked" : ""
                }>
                        <label class="form-check-label">Ya</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="q${nomorGlobal}" value="Tidak" ${
                  jawaban === "Tidak" ? "checked" : ""
                }>
                        <label class="form-check-label">Tidak</label>
                      </div>
                    </div>
                  `;
                if (kategori.includes("Aktivitas Fisik")) {
                  inputField = `
                      <div class="d-flex align-items-center">
                        <input type="number" min="0" max="7" class="form-control"
                          name="q${nomorGlobal}" value="${jawaban}" style="width:80px;">
                        <span class="ms-2">(hari) *</span>
                      </div>
                    `;
                }

                tableBody.append(`
                    <tr>
                      <td style="padding-left:20px;">${nomorSub}. ${kolom}</td>
                      <td style="width:10%;">${inputField}</td>
                    </tr>
                  `);
                nomorSub++;
                nomorGlobal++;
              });
            }
            // ... (kode kategoriMap & generate pertanyaan tetap sama)
          } else {
            Swal.fire(
              "Gagal memuat",
              (res && res.message) || "Coba lagi nanti.",
              "error"
            );
          }
        } catch (err) {
          Swal.close();
          Swal.fire(
            "‚ö† Error",
            "Gagal mengambil data (timeout / koneksi).",
            "error"
          );
          console.error(err);
        }
      }

      loadData();
      // di akhir loadData()
      currentStatus = hitungProgress();

      // tombol simpan
      $("#btnSimpan").on("click", async function () {
        const data = { ...dataAsli };

        $("#pemeriksaanTable tbody tr").each(function () {
          if ($(this).find("input").length === 0) return;

          const pertanyaan = $(this)
            .find("td:first")
            .text()
            .replace(/^\d+\.\s*/, "")
            .trim();
          let jawaban = "";

          if ($(this).find("input[type=number]").length > 0) {
            jawaban = $(this).find("input[type=number]").val() || "";
          } else if ($(this).find("input[type=radio]:checked").length > 0) {
            jawaban = $(this).find("input[type=radio]:checked").val() || "";
          }

          if (pertanyaan) data[pertanyaan] = jawaban;
        });

        data["kelas"] = "Kelas 1";
        data["action"] = "edit";
        data["index"] = dataAsli.index; // ‚úÖ tambahkan index agar tidak error

        Swal.fire({
          title: "Menyimpan...",
          text: "Mohon tunggu sebentar",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        try {
          const response = await fetch(
            "https://script.google.com/macros/s/AKfycbxvijgSaKZqTv2I84_wGTL3LTM3MqaPUQY8GNoKc3qvE6y94hI07yI37LxpbijoE6KM/exec?kelas=Kelas 1",
            { method: "POST", body: new URLSearchParams(data) }
          );
          const json = await response.json();

          if (json?.success) {
            Swal.fire("‚úÖ Sukses", "Data berhasil diperbarui!", "success");
            localStorage.removeItem("skrining_data_" + siswaId);
            if (data["status"]) updateWave(data["status"]);
          } else {
            Swal.fire(
              "‚ö† Gagal",
              json?.message || "Terjadi kesalahan.",
              "error"
            );
          }
        } catch (err) {
          Swal.fire("‚ö† Error", "Tidak bisa menyimpan data.", "error");
          console.error(err);
        }
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Skrining CKG</title>

    <!-- Bootstrap & DataTables -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        padding-top: 70px;
        padding-bottom: 60px;
        background-color: #f8f9fa;
      }
      .table-sm td,
      .table-sm th {
        font-size: 12px !important;
      }
      thead th {
        top: 0;
        background-color: #212529;
        color: white;
        z-index: 2;
      }
      #signaturePad {
        touch-action: none;
        cursor: crosshair;
        border: 1px solid #ccc;
      }
      #signaturePad {
  border: 2px solid #ccc;
  touch-action: none; /* penting agar bisa digambar di touchscreen */
}

    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-light bg-white bg-gradient fixed-top shadow">
      <div class="container d-flex justify-content-between align-items-center">
        <span class="navbar-brand mb-0 h5 text-success">
          <i class="bi bi-bar-chart-line"></i> Register PKG Siswa SMK KARYA
          DHARMA 2 TRENGGALEK
        </span>
        <button
          onclick="history.back()"
          class="btn btn-outline-secondary btn-sm"
        >
          <i class="bi bi-arrow-left-circle"></i> Kembali
        </button>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- Header + Button -->
      <div
        class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"
      >
        <h4 class="text-success mb-0">
          <u>Data Siswa Kelas 1 </u>
        </h4>
        <div class="d-flex gap-2">
          <a
            href="https://docs.google.com/spreadsheets/d/1zz2Xe7aCGF7oYdXrmav4VSSKDzMDEAefOiqr0fESwOc/edit?usp=sharing"
            target="_blank"
            class="btn btn-outline-danger btn-sm shadow"
          >
            <i class="bi bi-file-earmark-richtext"></i> View Source Data
          </a>
        </div>
      </div>

      <!-- Tabel -->
      <div class="card shadow">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered table-sm" id="dataTable">
              <thead id="tableHead" class="table-success bg-gradient"></thead>
              <tbody id="tableBody">
                <tr class="text-center">
                  <td colspan="100%">
                    <div
                      class="spinner-border text-primary"
                      role="status"
                    ></div>
                    <div>Memuat data...</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Detail Data  -->
    <div class="modal fade" id="detailModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detail Skrining</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div id="detailContent"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal TTD -->
    <div class="modal fade" id="ttdModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form id="ttdForm">
            <div class="modal-header">
              <h5 class="modal-title">Tanda Tangan Siswa</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <canvas
                id="signaturePad"
                style="width: 100%; height: 150px"
              ></canvas>
              <button
                type="button"
                class="btn btn-sm btn-secondary mt-2"
                id="clearBtn"
              >
                Bersihkan
              </button>
            </div>
            <div class="modal-footer">
              <input type="hidden" id="rowIndex" />
              <button type="submit" class="btn btn-primary">Simpan TTD</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light text-dark text-center py-2 fixed-bottom">
      <div class="container">
        &copy; 2025 Puskesmas Trenggalek | Aplikasi Skrining Siswa
      </div>
    </footer>

    <!-- Script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- SignaturePad -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbzJg3UApEqEFpev3NrfC6JceUt0QEIlvhPBVBCp8TQP5Ru-gXO3SfgA55v7H8AQnsE-/exec";

      const VISIBLE_COLUMNS = [
        "No",
        "Nama",
        "Kelas",
        "Jk",
        "NIK",
        "Tempat Lahir",
        "Tanggal Lahir",
        "Alamat",
        "No Telp",
      ];

      let signaturePad, rowIndexGlobal;

      async function loadData() {
        try {
          const res = await fetch(`${API_URL}?kelas=Kelas 1`);
          const json = await res.json();

          if (!json.success) {
            Swal.fire("Error", json.message, "error");
            return;
          }

          // Header
          let headHtml = "<tr>";
          VISIBLE_COLUMNS.forEach(
            (h) => (headHtml += `<th>${h}</th>`)
          );
          headHtml += "<th>Skrining</th><th>TTD</th></tr>";
          document.getElementById("tableHead").innerHTML = headHtml;

          // Body
          let bodyHtml = "";
          json.data.forEach((row, idx) => {
            bodyHtml += "<tr>";
            VISIBLE_COLUMNS.forEach(
              (h) => (bodyHtml += `<td>${row[h] || ""}</td>`)
            );

            // Skrining
            bodyHtml += `
              <td class="text-center">
                <button class="btn btn-sm btn-info" onclick="showDetail(${idx})">
                  <i class="bi bi-eye"></i>
                </button>
              </td>`;

            // TTD
            const ttdUrl = row["TTD"] || "";
            if (ttdUrl) {
              bodyHtml += `
                <td class="text-center">
                  <a href="${ttdUrl}" target="_blank" class="btn btn-sm btn-outline-success">
                    <i class="bi bi-pen"></i> Lihat
                  </a>
                  <button class="btn btn-sm btn-outline-primary" onclick="openTTDModal(${idx})">
                    <i class="bi bi-pencil-square"></i> Ubah
                  </button>
                </td>`;
            } else {
              bodyHtml += `
                <td class="text-center">
                  <button class="btn btn-sm btn-outline-primary" onclick="openTTDModal(${idx})">
                    <i class="bi bi-pencil-square"></i> TTD
                  </button>
                </td>`;
            }
            bodyHtml += "</tr>";
          });

          document.getElementById("tableBody").innerHTML = bodyHtml;
          $("#dataTable").DataTable();
          window._dataCache = json;
        } catch (err) {
          Swal.fire("Error", "Gagal memuat data: " + err.message, "error");
        }
      }

      function showDetail(index) {
  const data = window._dataCache.data[index];
  const headers = window._dataCache.headers;

  // cari index awal pertanyaan
  const startIdx = headers.findIndex(h =>
    h.trim().startsWith("Dalam 2 minggu terakhir")
  );
  const endIdx = headers.findIndex(h => h.trim().toLowerCase() === "ttd");

  let html = "<form id='detailForm'><table class='table table-bordered table-sm'>";

  headers.forEach((h, i) => {
    const key = h.trim();
    const val = data[h] || "";

    if (key.toLowerCase() === "ttd") {
      if (val) {
        html += `<tr><th>${h}</th><td><a href="${val}" target="_blank">Lihat TTD</a></td></tr>`;
      }
    } else if (key.toLowerCase() === "tanggal lahir") {
      // ubah format ISO ke YYYY-MM-DD
      let dateVal = "";
      if (val) {
        const d = new Date(val);
        if (!isNaN(d)) {
          dateVal = d.toISOString().split("T")[0];
        }
      }
      html += `<tr><th>${h}</th>
        <td><input type="date" class="form-control form-control-sm" name="${h}" value="${dateVal}"></td></tr>`;
    } else if (i >= startIdx && i < endIdx) {
      // semua kolom di range pertanyaan â†’ dropdown Ya/Tidak
      html += `<tr><th>${h}</th>
        <td>
          <select class="form-select form-select-sm" name="${h}">
            <option value="" ${val===""?"selected":""}>--Pilih--</option>
            <option value="Ya" ${val==="Ya"?"selected":""}>Ya</option>
            <option value="Tidak" ${val==="Tidak"?"selected":""}>Tidak</option>
          </select>
        </td></tr>`;
    } else {
      // default text
      html += `<tr><th>${h}</th>
        <td><input type="text" class="form-control form-control-sm" name="${h}" value="${val}"></td></tr>`;
    }
  });

  html += `</table>
    <div class="text-end">
      <button type="submit" class="btn btn-success btn-sm">Simpan Perubahan</button>
    </div></form>`;

  document.getElementById("detailContent").innerHTML = html;

  const modal = new bootstrap.Modal(document.getElementById("detailModal"));
  modal.show();

  // handle submit
  document.getElementById("detailForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    const payload = new URLSearchParams();
    payload.append("kelas", "Kelas 1");
    payload.append("action", "edit");
    payload.append("index", index + 2);

    for (const [k, v] of formData.entries()) {
      payload.append(k, v);
    }

    try {
      const res = await fetch(API_URL, { method: "POST", body: payload });
      const json = await res.json();
      if (json.success) {
        Swal.fire("Sukses", "Data berhasil diperbarui.", "success");
        modal.hide();
        loadData();
      } else {
        Swal.fire("Error", json.message, "error");
      }
    } catch (err) {
      Swal.fire("Error", err.message, "error");
    }
  });
}

      // --- Bagian TTD ---
      function openTTDModal(index) {
  rowIndexGlobal = index + 2; 
  const modalEl = document.getElementById("ttdModal");
  const canvas = document.getElementById("signaturePad");
  const ctx = canvas.getContext("2d");

  // Pastikan reset sebelum tampil
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Tunggu modal benar-benar ditampilkan
  modalEl.addEventListener("shown.bs.modal", () => {
    canvas.width = modalEl.querySelector(".modal-body").clientWidth - 20; // lebar modal body
    canvas.height = 200;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    signaturePad = new SignaturePad(canvas, { backgroundColor: "white" });
  }, { once: true });

  new bootstrap.Modal(modalEl).show();
}


      document.getElementById("clearBtn").addEventListener("click", () => {
        if (signaturePad) signaturePad.clear();
      });

      document
        .getElementById("ttdForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (signaturePad.isEmpty()) {
            Swal.fire("Peringatan", "Silakan gambar tanda tangan dulu.", "warning");
            return;
          }

          const dataUrl = signaturePad.toDataURL("image/png");
          const base64Data = dataUrl.split(",")[1];

          try {
            const formData = new URLSearchParams();
            formData.append("kelas", "Kelas 1");
            formData.append("action", "edit");
            formData.append("index", rowIndexGlobal);
            formData.append("file", base64Data);
         formData.append("filename", `ttd_${Date.now()}.png`);
formData.append("mimetype", "image/png");


            const res = await fetch(API_URL, {
              method: "POST",
              body: formData,
            });
            const json = await res.json();

            if (json.success) {
              Swal.fire("Sukses", "TTD berhasil disimpan.", "success");
              bootstrap.Modal.getInstance(
                document.getElementById("ttdModal")
              ).hide();
              loadData();
            } else {
              Swal.fire("Error", json.message, "error");
            }
          } catch (err) {
            Swal.fire("Error", "Gagal menyimpan TTD: " + err.message, "error");
          }
        });

      document.addEventListener("DOMContentLoaded", loadData);
    </script>
  </body>
</html>
